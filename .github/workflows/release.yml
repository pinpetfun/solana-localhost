name: Release

on:
  push:
    tags:
      - 'v*.*.*'  # è§¦å‘æ¡ä»¶ï¼šæ¨é€ç¬¦åˆ v*.*.* æ ¼å¼çš„ tag

jobs:
  build:
    name: Build for ${{ matrix.target }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          # macOS Intel
          - os: macos-latest
            target: x86_64-apple-darwin
            archive: tar.gz

          # macOS Apple Silicon
          - os: macos-latest
            target: aarch64-apple-darwin
            archive: tar.gz

          # Linux x86_64 (ä½¿ç”¨ zigbuild åœ¨ macOS ä¸Šæ„å»º)
          - os: macos-latest
            target: x86_64-unknown-linux-gnu
            archive: tar.gz
            use_zigbuild: true

          # Linux ARM64 (ä½¿ç”¨ zigbuild åœ¨ macOS ä¸Šæ„å»º)
          - os: macos-latest
            target: aarch64-unknown-linux-gnu
            archive: tar.gz
            use_zigbuild: true

          # Windows
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            archive: zip

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install Zig and cargo-zigbuild (for Linux builds on macOS)
        if: matrix.use_zigbuild == true
        run: |
          brew install zig
          cargo install cargo-zigbuild

      - name: Create default config.toml if not exists
        run: |
          if [ ! -f config.toml ]; then
            cat > config.toml << 'EOF'
          [proxy]
          # ç›‘å¬åœ°å€å’Œç«¯å£
          listen_host = "127.0.0.1"
          listen_port = 8899

          # ç›®æ ‡æœåŠ¡å™¨åœ°å€å’Œç«¯å£
          target_host = "api.mainnet-beta.solana.com"
          target_port = 443

          [logging]
          # æ—¥å¿—çº§åˆ«ï¼štrace, debug, info, warn, error
          level = "info"
          EOF
          fi
        shell: bash

      - name: Build
        run: |
          if [ "${{ matrix.use_zigbuild }}" == "true" ]; then
            cargo zigbuild --release --target ${{ matrix.target }}
          else
            cargo build --release --target ${{ matrix.target }}
          fi
        shell: bash

      - name: Package (Unix)
        if: matrix.os != 'windows-latest'
        run: |
          # åˆ›å»ºä¸´æ—¶ç›®å½•
          mkdir -p package

          # å¤åˆ¶å¯æ‰§è¡Œæ–‡ä»¶å’Œé…ç½®æ–‡ä»¶
          cp target/${{ matrix.target }}/release/solana-localhost package/
          cp config.toml package/

          # åˆ›å»º README
          cat > package/README.md << 'EOF'
          # Solana Localhost Proxy

          ## å¿«é€Ÿå¼€å§‹

          1. ç¼–è¾‘ `config.toml` é…ç½®æ–‡ä»¶ï¼ˆå¦‚éœ€è¦ï¼‰
          2. è¿è¡Œç¨‹åºï¼š
             ```bash
             ./solana-localhost
             ```

          ## é…ç½®è¯´æ˜

          è¯·æŸ¥çœ‹ `config.toml` æ–‡ä»¶ä¸­çš„æ³¨é‡Šäº†è§£å„é…ç½®é¡¹çš„å«ä¹‰ã€‚

          EOF

          # æ‰“åŒ…
          cd package
          tar czf ../solana-localhost-${{ matrix.target }}.tar.gz *
          cd ..
          echo "ASSET=solana-localhost-${{ matrix.target }}.tar.gz" >> $GITHUB_ENV

      - name: Package (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          # åˆ›å»ºä¸´æ—¶ç›®å½•
          New-Item -ItemType Directory -Force -Path package

          # å¤åˆ¶å¯æ‰§è¡Œæ–‡ä»¶å’Œé…ç½®æ–‡ä»¶
          Copy-Item target/${{ matrix.target }}/release/solana-localhost.exe package/
          Copy-Item config.toml package/

          # åˆ›å»º README
          @"
          # Solana Localhost Proxy

          ## å¿«é€Ÿå¼€å§‹

          1. ç¼–è¾‘ config.toml é…ç½®æ–‡ä»¶ï¼ˆå¦‚éœ€è¦ï¼‰
          2. è¿è¡Œç¨‹åºï¼š
             ``````
             solana-localhost.exe
             ``````

          ## é…ç½®è¯´æ˜

          è¯·æŸ¥çœ‹ config.toml æ–‡ä»¶ä¸­çš„æ³¨é‡Šäº†è§£å„é…ç½®é¡¹çš„å«ä¹‰ã€‚
          "@ | Out-File -FilePath package/README.md -Encoding UTF8

          # æ‰“åŒ…
          cd package
          7z a ../solana-localhost-${{ matrix.target }}.zip *
          cd ..
          echo "ASSET=solana-localhost-${{ matrix.target }}.zip" >> $env:GITHUB_ENV

      - name: Upload artifact
        uses: actions/upload-artifact@v3
        with:
          name: solana-localhost-${{ matrix.target }}
          path: ${{ env.ASSET }}

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v3
        with:
          path: ./artifacts

      - name: Generate changelog
        id: changelog
        run: |
          # è·å–æœ€æ–°ä¸¤ä¸ª tag ä¹‹é—´çš„æäº¤è®°å½•
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          if [ -z "$PREV_TAG" ]; then
            CHANGELOG=$(git log --pretty=format:"- %s" HEAD)
          else
            CHANGELOG=$(git log --pretty=format:"- %s" ${PREV_TAG}..HEAD)
          fi

          # å°†æ¢è¡Œç¬¦è½¬æ¢ä¸º GitHub Actions å¯ä»¥å¤„ç†çš„æ ¼å¼
          CHANGELOG="${CHANGELOG//'%'/'%25'}"
          CHANGELOG="${CHANGELOG//$'\n'/'%0A'}"
          CHANGELOG="${CHANGELOG//$'\r'/'%0D'}"

          echo "changelog=$CHANGELOG" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: ${{ github.ref_name }}
          draft: false
          prerelease: false
          files: ./artifacts/**/solana-localhost-*
          body: |
            ## ğŸ“‹ æ›´æ–°å†…å®¹

            ${{ steps.changelog.outputs.changelog }}

            ## ğŸ“¦ ä¸‹è½½è¯´æ˜

            æ¯ä¸ªå‘å¸ƒåŒ…éƒ½åŒ…å«ï¼š
            - å¯æ‰§è¡Œæ–‡ä»¶ï¼ˆ`solana-localhost` æˆ– `solana-localhost.exe`ï¼‰
            - é…ç½®æ–‡ä»¶ï¼ˆ`config.toml`ï¼‰
            - è¯´æ˜æ–‡æ¡£ï¼ˆ`README.md`ï¼‰

            ### macOS
            - Intel: `solana-localhost-x86_64-apple-darwin.tar.gz`
            - Apple Silicon: `solana-localhost-aarch64-apple-darwin.tar.gz`

            ### Linux
            - x86_64: `solana-localhost-x86_64-unknown-linux-gnu.tar.gz`
            - ARM64: `solana-localhost-aarch64-unknown-linux-gnu.tar.gz`

            ### Windows
            - x86_64: `solana-localhost-x86_64-pc-windows-msvc.zip`

            ### ä½¿ç”¨æ–¹æ³•

            **macOS/Linux:**
            ```bash
            # è§£å‹
            tar -xzf solana-localhost-*.tar.gz

            # æ·»åŠ æ‰§è¡Œæƒé™ï¼ˆå¦‚éœ€è¦ï¼‰
            chmod +x solana-localhost

            # ç¼–è¾‘é…ç½®ï¼ˆå¯é€‰ï¼‰
            vi config.toml

            # è¿è¡Œ
            ./solana-localhost
            ```

            **Windows:**
            ```powershell
            # è§£å‹ (PowerShell)
            Expand-Archive solana-localhost-*.zip -DestinationPath .

            # ç¼–è¾‘é…ç½®ï¼ˆå¯é€‰ï¼‰
            notepad config.toml

            # è¿è¡Œ
            .\solana-localhost.exe
            ```

            ## âš™ï¸ é…ç½®è¯´æ˜

            ç¨‹åºä½¿ç”¨ `config.toml` æ–‡ä»¶è¿›è¡Œé…ç½®ã€‚é»˜è®¤é…ç½®å°†æœ¬åœ° 8899 ç«¯å£ä»£ç†åˆ° Solana ä¸»ç½‘ RPCã€‚

            ---
            *ä½¿ç”¨ Zig äº¤å‰ç¼–è¯‘æŠ€æœ¯æ„å»ºï¼Œæ— éœ€ Docker*